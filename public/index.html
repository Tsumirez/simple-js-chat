<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="main.css">
    <title>Zef websockets chat</title>
  </head>
  <body>
    <ul id="messages"></ul>
    <ul id ="activeUsers"></ul>
    <form id="form" action="">
        <input type="text" id="nick" placeholder="your nick">
        <input id="input" autocomplete="off" disabled/><button>Send</button>
    </form>

    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script>
        var socket = io();
        let elems = ['messages', 'form','input','nick', 'activeUsers'];
        for(elem of elems) {this[elem] = document.getElementById(elem)}

        let msgHistory = new Array(3);
        msgHistory.fill(undefined);
        Object.seal(msgHistory);
        let historyCursor = 0;

        input.addEventListener('keydown', (e) => {
            if(e.keyCode==38 || e.keyCode == 40) {
                historyCursor = (((historyCursor+39-e.keyCode) % msgHistory.length +1) || msgHistory.length) -1;
                input.value = msgHistory[historyCursor];
            }
        })

        form.addEventListener('submit', e => {
            e.preventDefault();
            if(!input.disabled && input.value) {
                for(let z = msgHistory.length-1; z>0; z--) {
                    msgHistory[z] = msgHistory[z-1];
                }
                msgHistory[0] =input.value;
                console.log(msgHistory);
                socket.emit('chat message', input.value);
                input.value = '';
            }

            if(!nick.disabled && nick.value) {
                socket.emit('add user', nick.value);
                nick.disabled= true ;
                input.disabled = false;
                input.focus();
            }
        });

        socket.on('chat message', function(msg){
            let item = document.createElement('li');
            item.textContent = msg;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        })

        socket.on('user list', usersObj => {   
            activeUsers.replaceChildren();        
            usersObj.users.forEach(user =>  {
                let namePlate = document.createElement('li');
                let userLink = document.createElement('a');
                userLink.setAttribute('href',user);
                userLink.textContent = user;
                namePlate.appendChild(userLink);
                activeUsers.appendChild(namePlate);
            });   
        });
    </script>
  </body>
</html>